<!DOCTYPE html>

<html>

<head>
	<title>Stocks: FCC Stocks Watching Collaboration App</title>
	<link href="/public/css/main.css" rel="stylesheet" type="text/css">
	<script type="text/javascript" src="common/ajax-functions.js"></script>
	<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
	<script type="text/javascript" src="controllers/streamController.client.js"></script>
	<script type="text/javascript" src="controllers/stockswatch.client.js"></script>
	<script type="text/javascript">		
		STREAMLIB.init([null, null, null]);
		STOCKSWATCH.init([null, null, null]);
		STOCKSWATCH.gc();
		STREAMLIB.loadExtScript("https://cdnjs.cloudflare.com/ajax/libs/deepstream.io-client-js/2.3.0/deepstream.js")
			.then(() => {
				return STREAMLIB.dsClient();
			})
			.then( (client) => {
				//function for "initial records list"
				if(client.getConnectionState() == "OPEN"){
					let stocks = client.record.getList( "stocks" );
					stocks.whenReady((list) => {
						//get the existing list of stock records...						
						var elA = Array.from(list.getEntries());
						//map the stocks and call "stock bulider" for each record
						var elB = elA.map((eachEntry) => {
							//Sync or Async?
							return new Promise((resolve, reject) => {
								client.record.has(eachEntry, (error, hasRecord) => {
									if(error){console.log("reJeckTed!"); reject(false); }
									else{
										var thisRecord = client.record.getRecord(eachEntry);
										thisRecord.whenReady((rdy) => {
											let symback = rdy.get("symbol");
											console.log(symback);
											resolve(symback);
										});	
									}//else
								});//has check
							});							
						});
						Promise.all(elB)
							.then((array) => {

								let queenMaker = array.map((stockSym) => {

									return new Promise((rezolve, rezect) => {
										console.log("the stockSym is " + stockSym);
										//all non-rejected elements
										if (stockSym !== false) {
											//add to DOM
											STREAMLIB.dsAdd(stockSym);
											//fetches stock data
											STREAMLIB.fetchAlpha(stockSym)
											.then((alpha) => {
												//process the alpha into chart format...						
												return STREAMLIB.formatAlpha(alpha);
											})
											.then((formed) => {
												//insert into global document array
												rezolve(STREAMLIB.add2Charts(formed));
											});
										}
									});
								});

								Promise.all(queenMaker)
									.then((done) => {
										let stocksArray = STREAMLIB.getCharts();
										STOCKSWATCH.drawFactory(stocksArray);
										console.log("resolved all entries " + array.length);
									})
									.catch((e) => {
										console.log(e);
									});
								//draw google chart
								
							});
					});							
				}
				return Promise.resolve(client);

			})			
			.then((client) => {
				//subscribe to events
				client.event.subscribe("stocks/add", (data) => {
					//generate DOM 
					//fetch alphavantage JSON: fetch(data)
					//.then -> populate placeholders
					//.then -> draw google chart

					//adds stock to DOM
					STREAMLIB.dsAdd(data);
					//fetches stock data
					STREAMLIB.fetchAlpha(data)
					.then((alpha) => {
						//process the alpha into chart format...						
						return STREAMLIB.formatAlpha(alpha);						
					})
					.then((formed) => {
						//insert into global document array
						var stocksArray  =  STREAMLIB.add2Charts(formed);
						//draw google chart
						STOCKSWATCH.drawFactory(stocksArray);
					});
				});			
				client.event.subscribe("stocks/remove", (data) => {
					//access DOM
					//.then -> remove chart node

					//emit REMOVE entry...
					STREAMLIB.dsRemove(data)
					.then((removedSymb) => {
						//remove the stock from the global array, then draw a new chart
						let newArray = STREAMLIB.delFromCharts(removedSymb);
						STOCKSWATCH.drawFactory(newArray);
					});
				});
				console.log("got to second level " + " " + client.getUid());
			});
	</script>

</head>
<header>
</header>

<body>
	<div id="navi" class="navi-menu">
		<!-- <div id="api-icon"></div>
		<div id="home-icon"></div>
		<div class="container" id="welcome-container">
			<p>Welcome to Nightlife Coordination App 2night<span id="display-name"></span>!</p>
			
			<span id="auth-container"></span>					
			<br>
			
			<div class="fb-login-button" data-max-rows="1" data-size="large" data-button-type="continue_with" data-show-faces="false" data-auto-logout-link="true" data-use-continue-as="false">
			</div>
			<div id="status"></div>		
		</div> -->
	</div>

	<div id="clock">
		<h3 id="clock-time">
			Welcome! To <i>Stocks Watch</i>!
		</h3>
	</div>


	<div id="stocks-super">
		<div id="bg-wrapper">
			<div id="bg-top" class="bg-img"></div>
			<div id = "chart-super">
				[CHART SUPER]
			</div>
			<div id="bg-bot" class="bg-img"></div>
		</div>
		<ul id="stocks-view" class="stocks-view-list"></ul>
	</div>
	
	<div class="container center-bar">
			<img id="zip-image" src="public/img/enterstocksymbol.png" alt="enter your zip:"/>
			<input type="text" id="zipSearch" name="q" placeholder="Stock symbol"/>						
		</div>
	

	<div id="events-sup">
		<div id="loading" lock="on">
			<div class="w3-animate-fading">
				<img id="loading-image" src="public/img/2night.gif" alt="Loading..." />
			</div>
		</div>

		<!--Div that will hold the polls-->
		<!-- 		<div id="pollDb">
			<img id="yourarea" src="public/img/yourarea.png" alt="Results" />
			<ul id="poll-view" class="poll-view-list"></ul>
		</div>

		<div id="profile-container" style="display: none">
			<div id="profile-navi">
				<img id="fresh-appts" src="public/img/refresh.png" alt="Reload my Appointments" />
			</div>
			<ul id="appts-view"></ul>
		</div> -->

	</div>
</body>

<footer>
	<script>
		STREAMLIB.asyncSetup();
	</script>
</footer>

</html>